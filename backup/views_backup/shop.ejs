<%- include('layout', { body: `
<!-- Hero Section -->
<section class="huella-hero">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="huella-fade-in">Loja Online</h1>
                <p class="lead huella-fade-in">Encomende os seus cookies favoritos e receba-os frescos em casa em apenas 3 dias úteis.</p>
            </div>
            <div class="col-lg-6 text-center">
                <img src="/img/shop/online-shopping.jpg" alt="Loja Online" class="img-fluid huella-fade-in" style="max-height: 400px;">
            </div>
        </div>
    </div>
</section>

<!-- Search and Filters -->
<section class="huella-section">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="huella-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-lg-6 mb-3 mb-lg-0">
                                <div class="input-group">
                                    <input type="text" class="form-control huella-form-control" id="searchInput" placeholder="Pesquisar cookies...">
                                    <button class="btn btn-huella-primary" type="button">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="btn btn-outline-huella-green active" data-filter="all">Todos</button>
                                    <button class="btn btn-outline-huella-green" data-filter="fixed">Fixos</button>
                                    <button class="btn btn-outline-huella-green" data-filter="seasonal">Sazonais</button>
                                    <button class="btn btn-outline-huella-green" data-filter="boxes">Caixas</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Products Grid -->
<section class="huella-section huella-section-alt">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center mb-5">
                <h2 class="huella-title">Os Nossos Cookies</h2>
                <p class="huella-text">Escolha os seus sabores favoritos</p>
            </div>
        </div>
        
        <!-- Individual Cookies -->
        <div class="row mb-5">
            <div class="col-12">
                <h3 class="huella-subtitle mb-4">Cookies Individuais</h3>
            </div>
            <% products.forEach(function(product) { %>
            <div class="col-lg-4 col-md-6 mb-4 product-card" data-category="<%= product.category %>">
                <div class="card huella-card h-100">
                    <div class="position-relative">
                        <img src="<%= product.image %>" class="card-img-top" alt="<%= product.name %>">
                        <% if (product.category === 'seasonal') { %>
                        <span class="position-absolute top-0 end-0 m-2 huella-badge huella-badge-seasonal"><i class="fas fa-star me-1"></i>Limitado</span>
                        <% } %>
                        <% if (!product.inStock) { %>
                        <span class="position-absolute top-0 start-0 m-2 huella-badge bg-secondary">Esgotado</span>
                        <% } %>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title product-name"><%= product.name %></h5>
                        <p class="card-text product-description flex-grow-1"><%= product.description %></p>
                        <div class="d-flex justify-content-between align-items-center mt-auto">
                            <span class="huella-price"><%= product.price.toFixed(2) %>€</span>
                            <div class="d-flex align-items-center gap-2">
                                <div class="quantity-selector d-flex align-items-center">
                                    <button class="btn btn-sm btn-outline-secondary quantity-minus">-</button>
                                    <input type="number" class="form-control form-control-sm quantity-input text-center" value="1" min="1" style="width: 60px;">
                                    <button class="btn btn-sm btn-outline-secondary quantity-plus">+</button>
                                </div>
                                <button class="btn btn-huella-primary btn-sm" <% if (!product.inStock) { %>disabled<% } %> onclick="<% if (product.inStock) { %>addToCart(<%= product.id %>, '<%= product.name.replace(/'/g, "\\'") %>', <%= product.price %>, '<%= product.image %>')<% } %>">
                                    <i class="fas fa-plus me-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <% }); %>
        </div>
        
        <!-- Mixed Boxes -->
        <div class="row">
            <div class="col-12">
                <h3 class="huella-subtitle mb-4">Caixas Mistas</h3>
            </div>
            <% boxes.forEach(function(box) { %>
            <div class="col-lg-4 col-md-6 mb-4 product-card" data-category="boxes">
                <div class="card huella-card h-100">
                    <img src="<%= box.image %>" class="card-img-top" alt="<%= box.name %>">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title product-name"><%= box.name %></h5>
                        <p class="card-text product-description flex-grow-1"><%= box.description %></p>
                        <div class="mb-3">
                            <span class="huella-price"><%= box.price.toFixed(2) %>€</span>
                            <% if (box.savings > 0) { %>
                            <small class="text-success d-block">Poupe <%= box.savings.toFixed(2) %>€</small>
                            <% } %>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-auto">
                            <div class="quantity-selector d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-secondary quantity-minus">-</button>
                                <input type="number" class="form-control form-control-sm quantity-input text-center" value="1" min="1" style="width: 60px;">
                                <button class="btn btn-sm btn-outline-secondary quantity-plus">+</button>
                            </div>
                            <button class="btn btn-huella-primary btn-sm" onclick="addToCart(<%= box.id %>, '<%= box.name.replace(/'/g, "\\'") %>', <%= box.price %>, '<%= box.image %>')">
                                <i class="fas fa-plus me-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <% }); %>
        </div>
    </div>
</section>

<!-- Shopping Cart Sidebar -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="cartOffcanvasLabel">
            <i class="fas fa-shopping-cart me-2"></i>Carrinho de Compras
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="cartItems">
            <p class="text-muted text-center">O seu carrinho está vazio</p>
        </div>
        <div class="mt-auto pt-3 border-top">
            <div class="d-flex justify-content-between mb-3">
                <strong>Total:</strong>
                <strong id="cartTotal">0,00€</strong>
            </div>
            <button class="btn btn-huella-primary w-100" onclick="proceedToCheckout()">
                <i class="fas fa-credit-card me-2"></i>Finalizar Encomenda
            </button>
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="checkoutModalLabel">Finalizar Encomenda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="checkoutForm" class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="huella-form-label">Nome *</label>
                            <input type="text" class="form-control huella-form-control" id="firstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="huella-form-label">Apelido *</label>
                            <input type="text" class="form-control huella-form-control" id="lastName" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="huella-form-label">Email *</label>
                        <input type="email" class="form-control huella-form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="huella-form-label">Telefone *</label>
                        <input type="tel" class="form-control huella-form-control" id="phone" required>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="huella-form-label">Morada Completa *</label>
                        <textarea class="form-control huella-form-control" id="address" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="postalCode" class="huella-form-label">Código Postal *</label>
                            <input type="text" class="form-control huella-form-control" id="postalCode" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="city" class="huella-form-label">Cidade *</label>
                            <input type="text" class="form-control huella-form-control" id="city" required>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Informação de Envio:</strong> O envio demora <%= shippingInfo.deliveryTime %> e custa <%= shippingInfo.shippingCost.toFixed(2) %>€. 
                        Envio gratuito para encomendas superiores a <%= shippingInfo.freeShippingThreshold.toFixed(2) %>€.
                    </div>
                    
                    <!-- Payment Methods Section -->
                    <div class="mb-4">
                        <h5 class="huella-subtitle mb-3">Métodos de Pagamento</h5>
                        <div class="payment-methods">
                            <div class="payment-method-card mb-3" data-method="dinheiro">
                                <div class="d-flex align-items-center justify-content-between p-3 huella-card" style="cursor: pointer;" onclick="selectPaymentMethod('dinheiro')">
                                    <div class="d-flex align-items-center">
                                        <div class="payment-icon me-3">
                                            <i class="fas fa-money-bill-wave fa-2x text-huella-green"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 text-huella-green fw-bold">DINHEIRO FÍSICO</h6>
                                            <p class="mb-0 text-huella-orange small">Pagamento feito no momento, em notas ou moedas.</p>
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="paymentDinheiro" value="dinheiro">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-method-card mb-3" data-method="mbway">
                                <div class="d-flex align-items-center justify-content-between p-3 huella-card" style="cursor: pointer;" onclick="selectPaymentMethod('mbway')">
                                    <div class="d-flex align-items-center">
                                        <div class="payment-icon me-3">
                                            <span class="badge bg-danger" style="font-size: 1.2rem; padding: 0.5rem;">MB</span>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 text-huella-green fw-bold">MB WAY</h6>
                                            <p class="mb-0 text-huella-orange small">Pagamento imediato através da app.</p>
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="paymentMBWay" value="mbway">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-method-card mb-3" data-method="revolut">
                                <div class="d-flex align-items-center justify-content-between p-3 huella-card" style="cursor: pointer;" onclick="selectPaymentMethod('revolut')">
                                    <div class="d-flex align-items-center">
                                        <div class="payment-icon me-3">
                                            <span class="badge bg-dark" style="font-size: 1.5rem; padding: 0.5rem; font-weight: bold;">R</span>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 text-huella-green fw-bold">REVOLUT</h6>
                                            <p class="mb-0 text-huella-orange small">Transferência instantânea de conta para conta.</p>
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="paymentRevolut" value="revolut">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-method-card mb-3" data-method="huella">
                                <div class="d-flex align-items-center justify-content-between p-3 huella-card" style="cursor: pointer;" onclick="selectPaymentMethod('huella')">
                                    <div class="d-flex align-items-center">
                                        <div class="payment-icon me-3">
                                            <i class="fas fa-cookie-bite fa-2x text-huella-orange"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 text-huella-orange fw-bold" style="font-size: 1.2rem;">Huella</h6>
                                            <p class="mb-0 text-huella-orange small">*Finalizamos os valores e detalhes individualmente com cada cliente, para garantir clareza e acordo em cada passo.</p>
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="paymentHuella" value="huella">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Details (hidden by default) -->
                    <div id="paymentDetails" style="display: none;">
                        <div class="huella-card p-3 mb-3">
                            <h6 class="text-huella-green mb-3">Detalhes do Pagamento</h6>
                            <div id="paymentDetailsContent"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="checkoutForm" class="btn btn-huella-primary">
                    <i class="fas fa-credit-card me-2"></i>Confirmar Encomenda
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Shipping Information -->
<section class="huella-section huella-section-green">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center mb-5">
                <h2 class="text-white">Informações de Envio</h2>
                <p class="text-white-50">Entregamos em todo o território nacional</p>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="text-center text-white">
                    <div class="mb-3">
                        <i class="fas fa-shipping-fast fa-3x text-huella-yellow"></i>
                    </div>
                    <h5>Entrega Rápida</h5>
                    <p class="text-white-50"><%= shippingInfo.deliveryTime %> para todo o país</p>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="text-center text-white">
                    <div class="mb-3">
                        <i class="fas fa-gift fa-3x text-huella-yellow"></i>
                    </div>
                    <h5>Embalagem Especial</h5>
                    <p class="text-white-50">Cookies frescos em embalagem sustentável</p>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="text-center text-white">
                    <div class="mb-3">
                        <i class="fas fa-shield-alt fa-3x text-huella-yellow"></i>
                    </div>
                    <h5>Garantia de Qualidade</h5>
                    <p class="text-white-50">Cookies sempre frescos ou o seu dinheiro de volta</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Call to Action -->
<section class="huella-section">
    <div class="container">
        <div class="row justify-content-center text-center">
            <div class="col-lg-8">
                <h2 class="huella-title">Pronto para Encomendar?</h2>
                <p class="huella-text mb-4">Adicione os seus cookies favoritos ao carrinho e receba-os frescos em casa.</p>
                <button class="btn btn-huella-primary btn-lg" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
                    <i class="fas fa-shopping-cart me-2"></i>Ver Carrinho
                </button>
            </div>
        </div>
    </div>
</section>

<script>
// Cart functionality
let cart = JSON.parse(localStorage.getItem('huellaCart')) || [];

function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-muted text-center">O seu carrinho está vazio</p>';
        cartTotal.textContent = '0,00€';
        return;
    }
    
    let total = 0;
    let itemsHtml = '';
    
    cart.forEach(function(item) {
        total += item.price * item.quantity;
        itemsHtml += '<div class="d-flex justify-content-between align-items-center mb-3">' +
            '<div class="flex-grow-1">' +
            '<h6 class="mb-1">' + item.name + '</h6>' +
            '<small class="text-muted">' + item.quantity + 'x ' + item.price.toFixed(2) + '€</small>' +
            '</div>' +
            '<div class="d-flex align-items-center gap-2">' +
            '<button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(' + item.id + ', -1)">-</button>' +
            '<span>' + item.quantity + '</span>' +
            '<button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(' + item.id + ', 1)">+</button>' +
            '<button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(' + item.id + ')">' +
            '<i class="fas fa-trash"></i>' +
            '</button>' +
            '</div>' +
            '</div>';
    });
    
    cartItems.innerHTML = itemsHtml;
    cartTotal.textContent = total.toFixed(2) + '€';
}

function updateQuantity(id, change) {
    const item = cart.find(item => item.id === id);
    if (item) {
        item.quantity += change;
        if (item.quantity <= 0) {
            cart = cart.filter(item => item.id !== id);
        }
        localStorage.setItem('huellaCart', JSON.stringify(cart));
        updateCartDisplay();
        updateCartCount();
    }
}

function removeFromCart(id) {
    cart = cart.filter(item => item.id !== id);
    localStorage.setItem('huellaCart', JSON.stringify(cart));
    updateCartDisplay();
    updateCartCount();
}

function proceedToCheckout() {
    if (cart.length === 0) {
        alert('O seu carrinho está vazio!');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
    modal.show();
}

// Payment Method Selection
function selectPaymentMethod(method) {
    // Uncheck all radio buttons
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.checked = false;
    });
    
    // Check selected method
    document.getElementById('payment' + method.charAt(0).toUpperCase() + method.slice(1)).checked = true;
    
    // Show payment details
    const paymentDetails = document.getElementById('paymentDetails');
    const paymentDetailsContent = document.getElementById('paymentDetailsContent');
    paymentDetails.style.display = 'block';
    
    // Clear previous content
    paymentDetailsContent.innerHTML = '';
    
    // Show appropriate payment simulation based on method
    switch(method) {
        case 'dinheiro':
            showDinheiroPayment();
            break;
        case 'mbway':
            showMBWayPayment();
            break;
        case 'revolut':
            showRevolutPayment();
            break;
        case 'huella':
            showHuellaPayment();
            break;
    }
}

function showDinheiroPayment() {
    const content = document.getElementById('paymentDetailsContent');
    content.innerHTML = '<div class="alert alert-success">' +
        '<i class="fas fa-check-circle me-2"></i>' +
        '<strong>Pagamento em Dinheiro Físico</strong>' +
        '<p class="mb-0 mt-2">O pagamento será feito no momento da entrega ou recolha. Prepare o valor exato ou próximo.</p>' +
        '</div>' +
        '<div class="mt-3">' +
        '<p class="mb-2"><strong>Total a pagar:</strong> <span id="totalAmount" class="huella-price"></span></p>' +
        '<p class="text-muted small">*O valor será confirmado no momento da entrega.</p>' +
        '</div>';
    updateTotalAmount();
}

function showMBWayPayment() {
    const content = document.getElementById('paymentDetailsContent');
    content.innerHTML = '<div class="alert alert-info">' +
        '<i class="fas fa-mobile-alt me-2"></i>' +
        '<strong>Pagamento via MB WAY</strong>' +
        '</div>' +
        '<div class="mb-3">' +
        '<label for="mbwayPhone" class="huella-form-label">Número de Telemóvel MB WAY *</label>' +
        '<input type="tel" class="form-control huella-form-control" id="mbwayPhone" placeholder="9XXXXXXXX" pattern="[0-9]{9}" required>' +
        '<small class="text-muted">Número associado à sua conta MB WAY</small>' +
        '</div>' +
        '<div class="mt-3">' +
        '<p class="mb-2"><strong>Total a pagar:</strong> <span id="totalAmount" class="huella-price"></span></p>' +
        '<button type="button" class="btn btn-huella-primary w-100" onclick="simulateMBWayPayment()">' +
        '<i class="fas fa-mobile-alt me-2"></i>Enviar Pedido de Pagamento MB WAY' +
        '</button>' +
        '</div>';
    updateTotalAmount();
}

function showRevolutPayment() {
    const content = document.getElementById('paymentDetailsContent');
    content.innerHTML = '<div class="alert alert-info">' +
        '<i class="fas fa-exchange-alt me-2"></i>' +
        '<strong>Pagamento via Revolut</strong>' +
        '</div>' +
        '<div class="mb-3">' +
        '<label for="revolutEmail" class="huella-form-label">Email da Conta Revolut *</label>' +
        '<input type="email" class="form-control huella-form-control" id="revolutEmail" placeholder="seu@email.com" required>' +
        '</div>' +
        '<div class="mb-3">' +
        '<label for="revolutPhone" class="huella-form-label">Número de Telemóvel Revolut *</label>' +
        '<input type="tel" class="form-control huella-form-control" id="revolutPhone" placeholder="9XXXXXXXX" pattern="[0-9]{9}" required>' +
        '</div>' +
        '<div class="mt-3">' +
        '<p class="mb-2"><strong>Total a pagar:</strong> <span id="totalAmount" class="huella-price"></span></p>' +
        '<p class="text-muted small mb-3">Receberá os detalhes da conta para transferência após confirmação da encomenda.</p>' +
        '<button type="button" class="btn btn-huella-primary w-100" onclick="simulateRevolutPayment()">' +
        '<i class="fas fa-exchange-alt me-2"></i>Confirmar e Receber Detalhes de Transferência' +
        '</button>' +
        '</div>';
    updateTotalAmount();
}

function showHuellaPayment() {
    const content = document.getElementById('paymentDetailsContent');
    content.innerHTML = '<div class="alert alert-warning">' +
        '<i class="fas fa-cookie-bite me-2"></i>' +
        '<strong>Pagamento Personalizado Huella</strong>' +
        '</div>' +
        '<div class="mb-3">' +
        '<p class="huella-text">Finalizamos os valores e detalhes individualmente com cada cliente, para garantir clareza e acordo em cada passo.</p>' +
        '<p class="huella-text">Após submeter a encomenda, entraremos em contacto consigo para acordar os detalhes do pagamento.</p>' +
        '</div>' +
        '<div class="mb-3">' +
        '<label for="huellaNotes" class="huella-form-label">Observações ou Preferências de Pagamento</label>' +
        '<textarea class="form-control huella-form-control" id="huellaNotes" rows="3" placeholder="Indique a sua preferência de pagamento ou qualquer observação..."></textarea>' +
        '</div>' +
        '<div class="mt-3">' +
        '<p class="mb-2"><strong>Total estimado:</strong> <span id="totalAmount" class="huella-price"></span></p>' +
        '<p class="text-muted small">*O valor final será confirmado após contacto.</p>' +
        '</div>';
    updateTotalAmount();
}

function updateTotalAmount() {
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const freeShippingThreshold = <%= shippingInfo.freeShippingThreshold %>;
    const shippingCost = <%= shippingInfo.shippingCost %>;
    const shipping = total >= freeShippingThreshold ? 0 : shippingCost;
    const finalTotal = total + shipping;
    
    const totalElement = document.getElementById('totalAmount');
    if (totalElement) {
        totalElement.textContent = finalTotal.toFixed(2) + '€';
    }
}

function simulateMBWayPayment() {
    const phone = document.getElementById('mbwayPhone').value;
    if (!phone || phone.length !== 9) {
        alert('Por favor, insira um número de telemóvel válido (9 dígitos).');
        return;
    }
    
    // Simulate MB Way payment
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>A processar...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Pedido Enviado!';
        btn.classList.remove('btn-huella-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            processOrder('mbway', { phone: phone });
        }, 1500);
    }, 2000);
}

function simulateRevolutPayment() {
    const email = document.getElementById('revolutEmail').value;
    const phone = document.getElementById('revolutPhone').value;
    
    if (!email || !phone || phone.length !== 9) {
        alert('Por favor, preencha todos os campos corretamente.');
        return;
    }
    
    // Simulate Revolut payment
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>A processar...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Detalhes Enviados!';
        btn.classList.remove('btn-huella-primary');
        btn.classList.add('btn-success');
        
        // Show account details
        const content = document.getElementById('paymentDetailsContent');
        const reference = 'HUE' + Date.now().toString().slice(-6);
        content.innerHTML += '<div class="alert alert-success mt-3">' +
            '<h6><i class="fas fa-info-circle me-2"></i>Detalhes para Transferência:</h6>' +
            '<p class="mb-1"><strong>IBAN:</strong> PT50 0000 0000 0000 0000 0000 0</p>' +
            '<p class="mb-1"><strong>Referência:</strong> ' + reference + '</p>' +
            '<p class="mb-0"><strong>Valor:</strong> <span id="totalAmount" class="huella-price"></span></p>' +
            '<p class="small mt-2 mb-0">Envie a transferência e a encomenda será processada.</p>' +
            '</div>';
        updateTotalAmount();
        
        setTimeout(() => {
            processOrder('revolut', { email: email, phone: phone });
        }, 2000);
    }, 2000);
}

function processOrder(paymentMethod, paymentData) {
    const form = document.getElementById('checkoutForm');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }
    
    const formData = {
        items: cart,
        customerInfo: {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            postalCode: document.getElementById('postalCode').value,
            city: document.getElementById('city').value
        },
        paymentMethod: paymentMethod,
        paymentData: paymentData,
        total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
    };
    
    // Add Huella notes if applicable
    if (paymentMethod === 'huella' && document.getElementById('huellaNotes')) {
        formData.huellaNotes = document.getElementById('huellaNotes').value;
    }
    
    // Submit order
    fetch('/loja/checkout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear cart
            cart = [];
            localStorage.setItem('huellaCart', JSON.stringify(cart));
            updateCartDisplay();
            updateCartCount();
            
            // Show success message
            showOrderSuccess(data, paymentMethod);
        } else {
            alert('Erro ao processar encomenda. Por favor, tente novamente.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao processar encomenda. Por favor, tente novamente.');
    });
}

function showOrderSuccess(data, paymentMethod) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('checkoutModal'));
    modal.hide();
    
    const successMessage = paymentMethod === 'dinheiro' 
        ? 'Encomenda confirmada! Entraremos em contacto para combinar a entrega e pagamento.'
        : paymentMethod === 'huella'
        ? 'Encomenda registada! Entraremos em contacto para finalizar os detalhes do pagamento.'
        : 'Encomenda processada com sucesso! Receberá um email de confirmação em breve.';
    
    const alert = document.createElement('div');
    alert.className = 'alert alert-success position-fixed';
    alert.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 350px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);';
    alert.innerHTML = '<h5><i class="fas fa-check-circle me-2"></i>Encomenda Confirmada!</h5>' +
        '<p class="mb-1"><strong>Número de Encomenda:</strong> ' + data.orderNumber + '</p>' +
        '<p class="mb-1">' + successMessage + '</p>' +
        '<p class="mb-0 small"><strong>Entrega estimada:</strong> ' + data.estimatedDelivery + '</p>';
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 8000);
}

// Update form submit to use payment method
document.addEventListener('DOMContentLoaded', function() {
    const checkoutForm = document.getElementById('checkoutForm');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedMethod) {
                alert('Por favor, selecione um método de pagamento.');
                return;
            }
            
            const method = selectedMethod.value;
            const paymentData = {};
            
            if (method === 'mbway') {
                const phone = document.getElementById('mbwayPhone').value;
                if (!phone) {
                    alert('Por favor, insira o número de telemóvel MB WAY.');
                    return;
                }
                paymentData.phone = phone;
                simulateMBWayPayment();
            } else if (method === 'revolut') {
                const email = document.getElementById('revolutEmail').value;
                const phone = document.getElementById('revolutPhone').value;
                if (!email || !phone) {
                    alert('Por favor, preencha todos os campos do Revolut.');
                    return;
                }
                paymentData.email = email;
                paymentData.phone = phone;
                simulateRevolutPayment();
            } else if (method === 'dinheiro') {
                processOrder('dinheiro', {});
            } else if (method === 'huella') {
                const notes = document.getElementById('huellaNotes') ? document.getElementById('huellaNotes').value : '';
                processOrder('huella', { notes: notes });
            }
        });
    }
});

// Filter functionality
document.querySelectorAll('[data-filter]').forEach(button => {
    button.addEventListener('click', function() {
        const filter = this.dataset.filter;
        
        // Update active button
        document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        // Filter products
        document.querySelectorAll('.product-card').forEach(card => {
            if (filter === 'all' || card.dataset.category === filter) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
});

// Initialize cart display
updateCartDisplay();
</script>
` }) %>

